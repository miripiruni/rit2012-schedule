var talks = [
    {
        "title"  : "Growing in the Wild. The story by CUBRID Database Developers",
        "author" : "Esen Sagynov, Eugene Stoyanovic",
        "start"  : 1333347300000,
        "end"    : 1333350000000,
        "room"   : 1,
        "type"   : "db"
    },
    {
        "title"  : "Выбор подрядчика на IT-проекты: мечты заказчика и суровая реальность",
        "author" : "Ольга Павлова, Usability Lab",
        "start"  : 1333347300000,
        "end"    : 1333350000000,
        "room"   : 2,
        "type"   : "manage"
    },
    {
        "title"  : "Сетки для всего или как использовать чужие недостатки",
        "author" : "Василий Аксёнов, СКБ Контур",
        "start"  : 1333347300000,
        "end"    : 1333350000000,
        "room"   : 3,
        "type"   : "client-side"
    },
    {
        "title"  : "Introduction to Riak",
        "author" : "Ian Plosker",
        "start"  : 1333350000000,
        "end"    : 1333352700000,
        "room"   : 1,
        "type"   : "db"
    },
    {
        "title"  : "О том, как меняется функция управления продуктом в компании при ее росте от стартапа до корпорации",
        "author" : "Денис Бесков",
        "start"  : 1333350000000,
        "end"    : 1333352700000,
        "room"   : 2,
        "type"   : "manage"
    },
    {
        "title"  : "Профили<wbr>рование и оптимизация jQuery–кода",
        "author" : "Владимир Журавлев, Evil Martians",
        "start"  : 1333350000000,
        "end"    : 1333352700000,
        "room"   : 3,
        "type"   : "client-side"
    },
    {
        "title"  : "Welcome to Write-Ahead Log",
        "author" : "Heikki Olavi Linnakangas, PostgreSQL",
        "start"  : 1333352700000,
        "end"    : 1333355400000,
        "room"   : 1,
        "type"   : "db"
    },
    {
        "title"  : "Книга пяти колец. IT-прочтение",
        "author" : "Евгения Фирсова, Яндекс.Деньги",
        "start"  : 1333352700000,
        "end"    : 1333355400000,
        "room"   : 2,
        "type"   : "manage"
    },
    {
        "title"  : "Разработка сложного мульти<wbr>медийного приложения на JavaScript+HTML5 и PhoneGap для iPad",
        "author" : "Олег Неклюдов",
        "start"  : 1333352700000,
        "end"    : 1333355400000,
        "room"   : 3,
        "type"   : "client-side"
    },
    {
        "title"  : "Обед",
        "author" : "",
        "start"  : 1333355400000,
        "end"    : 1333358100000,
        "room"   : 1,
        "type"   : "gap"
    },
    {
        "title"  : "Как мы строили Jelastic - облачную платформу (PaaS) нового поколения",
        "author" : "Дмитрий Лазаренко, Дмитрий Сотников",
        "start"  : 1333355400000,
        "end"    : 1333358100000,
        "room"   : 2,
        "type"   : "db"
    },
    {
        "title"  : "Работа группы тестировщиков на десятке параллельных проектов",
        "author" : "Сергей Ношенков, Онтико",
        "start"  : 1333355400000,
        "end"    : 1333358100000,
        "room"   : 3,
        "type"   : "qa"
    },
    {
        "title"  : "Disruptive Media (высоко<wbr>технологичные медиа XXI века)",
        "author" : "Khaled Taha, Al Jazeera",
        "start"  : 1333358100000,
        "end"    : 1333360800000,
        "room"   : 1,
        "type"   : "future-tech"
    },
    {
        "title"  : "«Рамблер Касса» как пример высоко<wbr>производи<wbr>тельного проекта на .Net",
        "author" : "Дмитрий Паньшин, Рамблер-Афиша",
        "start"  : 1333358100000,
        "end"    : 1333360800000,
        "room"   : 2,
        "type"   : "server-side"
    },
    {
        "title"  : "Как не заразить посетителей своего сайта",
        "author" : "Александр Сидоров и Петр Волков, Яндекс",
        "start"  : 1333358100000,
        "end"    : 1333360800000,
        "room"   : 3,
        "type"   : "qa"
    },
    {
        "title"  : "Релиз-менеджмент в Badoo",
        "author" : "Илья Агеев и Юрий Насретдинов, Badoo",
        "start"  : 1333360800000,
        "end"    : 1333363500000,
        "room"   : 1,
        "type"   : "admin"
    },
    {
        "title"  : "Обед",
        "author" : "",
        "start"  : 1333360800000,
        "end"    : 1333363500000,
        "room"   : 2,
        "type"   : "gap"
    },
    {
        "title"  : "Обед",
        "author" : "",
        "start"  : 1333360800000,
        "end"    : 1333363500000,
        "room"   : 3,
        "type"   : "gap"
    },
    {
        "title"  : "Командное состояние потоков",
        "author" : "Дмитрий Сатин, Usability Lab",
        "start"  : 1333363500000,
        "end"    : 1333366200000,
        "room"   : 1,
        "type"   : "manage"
    },
    {
        "title"  : "Как не надо писать приложения, основанные на протоколе TCP",
        "author" : "Артём Гавриченков, HighLoad Lab",
        "start"  : 1333363500000,
        "end"    : 1333366200000,
        "room"   : 2,
        "type"   : "server-side"
    },
    {
        "title"  : "Адаптивный веб-дизайн на практике",
        "author" : "Антон Епрев, Mail.ru",
        "start"  : 1333363500000,
        "end"    : 1333366200000,
        "room"   : 3,
        "type"   : "client-side"
    },
    {
        "title" : "10 практических советов о том, как нанять лучшего IT-специалиста",
        "author" : "Алена Владимирская, PRUFFI",
        "start" : 1333366200000,
        "end" : 1333368900000,
        "room" : 1,
        "type" : "management"
    },
    {
        "title" : "Распре<wbr>деленные кэши: подводные камни",
        "author" : "Иван Головач",
        "start" : 1333366200000,
        "end" : 1333368900000,
        "room" : 2,
        "type" : "server-side"
    },
    {
        "title" : "Быстрый удар точно в цель",
        "author" : "Артемий Ломов",
        "start" : 1333366200000,
        "end" : 1333368000000,
        "room" : 3,
        "type" : "client-side"
    },
    {
        "title" : "HR для не HR менеджеров",
        "author" : "Александр Зиза, Алетейя-Бизнес",
        "start" : 1333368900000,
        "end" : 1333371600000,
        "room" : 1,
        "type" : "management"
    },
    {
        "title" : "JavaScript на сервере, 1ms на трансформа<wbr>цию",
        "author" : "Андрей Сумин, Mail.ru",
        "start" : 1333368900000,
        "end" : 1333371600000,
        "room" : 2,
        "type" : "server-side"
    },
    {
        "title" : "Эффекты OpenType в современной веб-типографике",
        "author" : "Ростислав Чебыкин",
        "start" : 1333368000000,
        "end" : 1333369800000,
        "room" : 3,
        "type" : "client-side"
    },
    {
        "title" : "Зачем переписывать то, что и так работает",
        "author" : "Сергей Константинов, Яндекс",
        "start" : 1333369800000,
        "end" : 1333371600000,
        "room" : 3,
        "type" : "client-side"
    },
    {
        "title"  : "Веб-выборы 2012 за 2012 часов",
        "author" : "Анна Степанян и Александр Журавлев, Undev",
        "start"  : 1333371600000,
        "end"    : 1333373400000,
        "room"   : 1,
        "type"   : "server-side"
    },
    {
        "title"  : "Кофе-брейк",
        "author" : "",
        "start"  : 1333371600000,
        "end"    : 1333373400000,
        "room"   : 2,
        "type"   : "gap"
    },
    {
        "title"  : "Кофе-брейк",
        "author" : "",
        "start"  : 1333371600000,
        "end"    : 1333373400000,
        "room"   : 3,
        "type"   : "gap"
    },
    {
        "title"  : "Окончательное решение вопроса трансляции видео в интернете",
        "author" : "Максим Лапшин, Erlyvideo",
        "start"  : 1333373400000,
        "end"    : 1333376100000,
        "room"   : 1,
        "type"   : "server-side"
    },
    {
        "title"  : "Интеграция сайта с облачным хранилищем",
        "author" : "Александр Демидов, 1C-Битрикс",
        "start"  : 1333373400000,
        "end"    : 1333376100000,
        "room"   : 2,
        "type"   : "db"
    },
    {
        "title"  : "Проектирование iPad приложений для топ-менеджеров",
        "author" : "Алексей Копылов, UI Design",
        "start"  : 1333373400000,
        "end"    : 1333376100000,
        "room"   : 3,
        "type"   : "qa"
    },
    {
        "title"  : "Технологии Badoo — открытая встреча",
        "author" : "",
        "start"  : 1333376100000,
        "end"    : 1333378800000,
        "room"   : 1,
        "type"   : "open"
    },
    {
        "title"  : "Почему вам еще рано в облако",
        "author" : "Станислав Богатырев, Clodo.ru",
        "start"  : 1333376100000,
        "end"    : 1333378800000,
        "room"   : 2,
        "type"   : "admin"
    },
    {
        "title"  : "Патентование Internet-разработок",
        "author" : "Михаил Радченко, SoftPatent",
        "start"  : 1333376100000,
        "end"    : 1333378800000,
        "room"   : 3,
        "type"   : "manage"
    }
];


inArray = Array.prototype.indexOf ?
    function (arr, val) {
        return arr.indexOf(val) != -1;
    } :
    function (arr, val) {
        var i = arr.length;
        while (i--) {
            if (a[i] === val) {
                return true;
            }
        }
        return false;
    };

var app = {
    debug : false,
    timeline : '',
    fav: '',
    favList : [],
    timeStep : 900000,
    rooms : [ [], [], [] ],
    roomTitles : ['Главный зал', 'Зал 2', 'Зал 3'],

    init : function (data) {
        data = this.prepareData(data);
        this.buildRooms(data);

        this.initFavNav();
        if(location.hash === '#favorites') {
            this.showFav();
            return;
        }

        this.buildTimeline();
        this.drawTimeline();
        this.setFavsCheckboxes();
    },

    showTimeline : function () {
        this.favList = [];
        this.buildTimeline();
        this.drawTimeline();
        this.setFavsCheckboxes();
        return false;
    },

    showFav : function () {
        var fav = this.getCookie('favorites');
        this.favList = [];
        if (fav) {
            this.fav = '<ul class="fav">';
            if (fav.indexOf(',') !== -1) {
                fav = fav.split(',');
               for (var i=0; i < fav.length; i++) {
                   this.collectFavItem(fav[i]);
               }
            } else {
                this.collectFavItem(fav);
            }
            this.favList.sort(function (a, b) {
                return (a.start > b.start) ? 1 : ((b.start > a.start) ? -1 : 0);
            });
            this.buildFavItems();
            this.fav+= '</ul>';
            document.getElementById('content').innerHTML = this.fav;
        } else {
            //location.assign('index.html#');
        }
        return false;
    },

    collectFavItem : function (fav) {
       for (var n = 0, l = talks.length; n < l; n++) {
           if (talks[n].id === fav) {
               this.favList[this.favList.length] = talks[n];
           }
       }
    },

    buildFavItems : function () {
        for (var i = 0, fl = this.favList.length; i < fl; i++) {
            for (var n = 0, l = talks.length; n < l; n++) {
                if (talks[n].id === this.favList[i].id) {
                    var talk = talks[n],
                    dtStart = new Date(talk.start),
                    m = dtStart.getMinutes() || '00',
                    time = dtStart.getHours() + ':' + m;
                    this.fav += '' +
                        '<li>' +
                        '<span class="time">' + time + '</span>, ' +
                        '<span class="room">' + this.roomTitles[talk.room -1] + '</span>: ' +
                        '<span class="title">' + talk.title + '</span> ' +
                        '<span class="author">' + talk.author + '</span>' +
                        '</li>';
                }
            }
       }
    },

    buildRooms : function (data) {
        for (var d = data.length, i = 0; d > i; i++) {
            var n = data[i].room - 1,
                talk = this.buildTalk(data[i]),
                rs = this.getRowspan(data[i]) - 1;
            this.rooms[n][this.rooms[n].length] = talk;
            // добавляем отступы, которые нужны для строительства table/tr
            while (rs > 0) {
                this.rooms[n].push('');
                rs--;
            }
        }
    },

    setFavsCheckboxes : function() {
        var fav = this.getCookie('favorites');
        if (fav) {
            if (fav.indexOf(',')) {
                fav = fav.split(',');
            }
            if (Object.prototype.toString.call(fav) == '[object Array]') {
                for (var k = 0, l = fav.length; l > k; k++) {
                    document.getElementById(fav[k]).checked = true;
                }
            } else {
                var f = document.getElementById(fav);
                if (f) {
                    f.checked = true;
                }
            }
        } else {
            var tip = document.getElementById('tip');
            tip.className = 'show';
            tip.innerHTML = 'Это неофициальная легкая, мобильная версия программы конференции РИТ++. Отметьте доклады, которые вам интересны и составьте свое расписание.';
        }
    },

    // На данный момент добавляет в JSON свойства id.
    prepareData : function (data) {
        var ret = data;
        for (var i=0; i < ret.length; i++) {
            ret[i].id = 'id_' + ret[i].start + '_' + ret[i].end + '_' + ret[i].room;
        }
        return ret;
    },

    getRowspan : function (talk) {
        return (talk.end - talk.start) / this.timeStep;
    },

    buildTalk : function (talk) {
        var rowspan = this.getRowspan(talk),
            id = talk.id,
            dtStart = new Date(talk.start),
            m = dtStart.getMinutes() || '00',
            time = dtStart.getHours() + ':' + m,
            ret = '<td class="talk room_' + talk.room + ' type_' + talk.type + '" rowspan="' + rowspan + '">' +
                        '<input type="checkbox" name="' + id + '" id="' + id + '" onchange="app.refreshFavorites(this.id)">' +
                        '<label for="' + id + '">' +
                            '<span class="time">' + time + '</span> ' +
                           '<span class="title">' + talk.title + '</span>' +
                           '<span class="author">' + talk.author + '</span>' +
                       '</label>' +
                    '</td>';
        return ret;
    },

    buildTimeline : function () {
        this.timeline = this.buildTimelineHeader();
        for (var l = this.rooms[0].length, i = 0; l > i; i++) {
            this.timeline += '<tr>';
            for (var k = this.rooms.length, n = 0; k > n; n++) {
                this.timeline += this.rooms[n][i] || '';
            }
            this.timeline += '</tr>';
        }
        return this.timeline;
    },

    buildTimelineHeader : function () {
        var h = '';
        for (var l = this.rooms.length, i = 0; l > i; i++) {
            h += '<th>' + this.roomTitles[i] + '</th>';
        }
        return '<thead><tr>' + h + '</tr></thead>';
    },

    drawTimeline : function () {
        var t = document.createElement('table');
        t.id = 'timeline';
        t.className = 'timeline';
        t.innerHTML = this.timeline;
        document.getElementById('content').innerHTML = '';
        document.getElementById('content').appendChild(t);
    },

    logTime : function () {
        var fDayStart = new Date('Mon Apr 02 2012 10:00:00 GMT+0400 (MSK)').getTime(),
            fDayEnd = new Date('Mon Apr 02 2012 19:00:00 GMT+0400 (MSK)').getTime();
        console.log('Rit starts at 2 apr, 10:00: ', fDayStart);
        for (var time = fDayStart; fDayEnd >= time; time += this.timeStep) {
            var t = new Date(time),
            m = t.getMinutes() || '00';
            console.log(t.getHours() + ':' + m, time);
        }
    },

    setCookie : function (name, val, exdays) {
        var exdate = new Date(),
            c_val;
        exdate.setDate(exdate.getDate() + exdays);
        c_val = escape(val) + ((exdays === null) ? "" : "; expires = " + exdate.toUTCString());
        document.cookie = name + '=' + c_val;
    },

    getCookie : function (name) {
        var i, x, y, ARRcookies = document.cookie.split(';');
        for (i = 0; i < ARRcookies.length; i++) {
            x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
            y = ARRcookies[i].substr(ARRcookies[i].indexOf('=') + 1);
            x= x.replace(/^\s+|\s+$/g,'');
            if (x === name) {
                return unescape(y);
            }
        }
        return;
    },

    addFavorites : function (id) {
        var fav = this.getCookie('favorites');
        if (fav) {
            // если уже есть такой ключ в куках то ничего не делаем
            if (inArray(fav.split(','), id)) { return false; }
            fav += ',';
        } else {
            fav = '';
        }
        fav += id;
        this.setCookie('favorites', fav, 10);

        if (fav !== '') {
            document.getElementById('modes').className = '';
        }
    },

    removeFavorites : function (id) {
        if (this.isFavorite(id)) {
            var fav = this.getCookie('favorites');
            if (fav.indexOf(id + ',') !== -1) {
                id = id + ',';
            } else if (fav.indexOf(',' + id) !== -1) {
                id = ',' + id;
            }
            fav = fav.replace(id, '');
            this.setCookie('favorites', fav, 10);

            if (fav === '') {
                document.getElementById('modes').className = 'modes_hidden';
            }
        }
    },

    isFavorite : function (id) {
        var ret = false,
            fav = this.getCookie('favorites'),
            arr = fav.split(',');
        if (fav && inArray(arr, id)) {
            ret = true;
        }
        return ret;
    },

    refreshFavorites : function (id) {
        if (document.getElementById(id).checked) {
            this.addFavorites(id);
        } else {
            this.removeFavorites(id);
        }
    },

    initFavNav : function () {
        var fav = this.getCookie('favorites');
        if (fav) {
            document.getElementById('modes').className = '';
        }
    }
};

//app.logTime(); // unixtime generator
app.init(talks);
